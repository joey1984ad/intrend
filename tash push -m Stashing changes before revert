[33mf3aa1e9[m Fix Facebook connect issues - improve SDK initialization and state management
[1mdiff --git a/FACEBOOK_PERMISSIONS_CHECKLIST.md b/FACEBOOK_PERMISSIONS_CHECKLIST.md[m
[1mindex 685e451..6c9b431 100644[m
[1m--- a/FACEBOOK_PERMISSIONS_CHECKLIST.md[m
[1m+++ b/FACEBOOK_PERMISSIONS_CHECKLIST.md[m
[36m@@ -1,4 +1,4 @@[m
[31m-# Facebook App Permissions & Features Checklist[m
[32m+[m[32mgi# Facebook App Permissions & Features Checklist[m
 [m
 ## Required Permissions for Marketing API Access[m
 [m
[1mdiff --git a/components/FacebookLogin.tsx b/components/FacebookLogin.tsx[m
[1mindex 37dc4b7..2fb1c64 100644[m
[1m--- a/components/FacebookLogin.tsx[m
[1m+++ b/components/FacebookLogin.tsx[m
[36m@@ -1,6 +1,6 @@[m
 'use client'[m
 [m
[31m-import React, { useEffect, useState } from 'react';[m
[32m+[m[32mimport React, { useEffect, useState, useCallback, useRef } from 'react';[m
 import { CheckCircle, AlertCircle, Loader2 } from 'lucide-react';[m
 [m
 interface FacebookLoginProps {[m
[36m@@ -19,6 +19,10 @@[m [mconst FacebookLogin: React.FC<FacebookLoginProps> = ({ onSuccess, onError }) =>[m
   const [isLoading, setIsLoading] = useState(false);[m
   const [isConnected, setIsConnected] = useState(false);[m
   const [userName, setUserName] = useState('');[m
[32m+[m[32m  const [sdkReady, setSdkReady] = useState(false);[m
[32m+[m[32m  const [sdkError, setSdkError] = useState<string | null>(null);[m
[32m+[m[32m  const [isInitializing, setIsInitializing] = useState(true);[m
[32m+[m[32m  const initAttempted = useRef(false);[m
 [m
   // Facebook App ID - Replace with your actual Facebook App ID[m
   const FB_APP_ID = process.env.NEXT_PUBLIC_FACEBOOK_APP_ID || 'your-facebook-app-id';[m
[36m@@ -27,28 +31,54 @@[m [mconst FacebookLogin: React.FC<FacebookLoginProps> = ({ onSuccess, onError }) =>[m
   console.log('ðŸ” FacebookLogin: FB_APP_ID =', FB_APP_ID);[m
   console.log('ðŸ” FacebookLogin: Is placeholder?', FB_APP_ID === 'your-facebook-app-id');[m
 [m
[31m-  useEffect(() => {[m
[32m+[m[32m  // Check if SDK is ready[m
[32m+[m[32m  const isSdkReady = useCallback(() => {[m
[32m+[m[32m    return window.FB && sdkReady && !isInitializing;[m
[32m+[m[32m  }, [sdkReady, isInitializing]);[m
[32m+[m
[32m+[m[32m  // Initialize Facebook SDK[m
[32m+[m[32m  const initializeFacebookSDK = useCallback(() => {[m
[32m+[m[32m    if (initAttempted.current) {[m
[32m+[m[32m      console.log('ðŸ”µ FacebookLogin: Initialization already attempted');[m
[32m+[m[32m      return;[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    initAttempted.current = true;[m
[32m+[m[32m    setIsInitializing(true);[m
[32m+[m[32m    console.log('ðŸ”µ FacebookLogin: Starting SDK initialization...');[m
[32m+[m
[32m+[m[32m    if (window.FB) {[m
[32m+[m[32m      console.log('ðŸ”µ FacebookLogin: FB already exists, checking status...');[m
[32m+[m[32m      setSdkReady(true);[m
[32m+[m[32m      setIsInitializing(false);[m
[32m+[m[32m      checkLoginStatus();[m
[32m+[m[32m      return;[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    console.log('ðŸ”µ FacebookLogin: Loading Facebook SDK...');[m
[32m+[m[41m    [m
     // Load Facebook SDK[m
[31m-    const loadFacebookSDK = () => {[m
[31m-      const script = document.createElement('script');[m
[31m-      script.src = 'https://connect.facebook.net/en_US/sdk.js';[m
[31m-      script.async = true;[m
[31m-      script.defer = true;[m
[31m-      script.crossOrigin = 'anonymous';[m
[31m-      document.head.appendChild(script);[m
[31m-[m
[31m-      script.onload = () => {[m
[31m-        console.log('ðŸ”µ FacebookLogin: Facebook SDK loaded successfully');[m
[31m-        window.fbAsyncInit = () => {[m
[31m-          console.log('ðŸ”µ FacebookLogin: fbAsyncInit called, initializing FB...');[m
[31m-          [m
[31m-          // Check if we have a valid App ID[m
[31m-          if (FB_APP_ID === 'your-facebook-app-id' || !FB_APP_ID) {[m
[31m-            console.error('âŒ FacebookLogin: Invalid App ID detected:', FB_APP_ID);[m
[31m-            console.error('âŒ FacebookLogin: Please update your .env.local file with a valid Facebook App ID');[m
[31m-            return;[m
[31m-          }[m
[31m-          [m
[32m+[m[32m    const script = document.createElement('script');[m
[32m+[m[32m    script.src = 'https://connect.facebook.net/en_US/sdk.js';[m
[32m+[m[32m    script.async = true;[m
[32m+[m[32m    script.defer = true;[m
[32m+[m[32m    script.crossOrigin = 'anonymous';[m
[32m+[m[41m    [m
[32m+[m[32m    script.onload = () => {[m
[32m+[m[32m      console.log('ðŸ”µ FacebookLogin: Facebook SDK loaded successfully');[m
[32m+[m[41m      [m
[32m+[m[32m      // Check if we have a valid App ID[m
[32m+[m[32m      if (FB_APP_ID === 'your-facebook-app-id' || !FB_APP_ID) {[m
[32m+[m[32m        console.error('âŒ FacebookLogin: Invalid App ID detected:', FB_APP_ID);[m
[32m+[m[32m        setSdkError('Invalid Facebook App ID. Please check your configuration.');[m
[32m+[m[32m        setIsInitializing(false);[m
[32m+[m[32m        return;[m
[32m+[m[32m      }[m
[32m+[m[41m      [m
[32m+[m[32m      window.fbAsyncInit = () => {[m
[32m+[m[32m        console.log('ðŸ”µ FacebookLogin: fbAsyncInit called, initializing FB...');[m
[32m+[m[41m        [m
[32m+[m[32m        try {[m
           window.FB.init({[m
             appId: FB_APP_ID,[m
             cookie: true,[m
[36m@@ -56,89 +86,190 @@[m [mconst FacebookLogin: React.FC<FacebookLoginProps> = ({ onSuccess, onError }) =>[m
             version: 'v23.0'[m
           });[m
           console.log('ðŸ”µ FacebookLogin: FB initialized with appId:', FB_APP_ID);[m
[31m-[m
[31m-          // Check if user is already logged in[m
[31m-          window.FB.getLoginStatus((response: any) => {[m
[31m-            console.log('ðŸ”µ FacebookLogin: getLoginStatus response:', response);[m
[31m-            if (response.status === 'connected') {[m
[31m-              console.log('ðŸ”µ FacebookLogin: User already connected');[m
[31m-              setIsConnected(true);[m
[31m-              setUserName(response.authResponse.userID);[m
[31m-              onSuccess(response.authResponse.accessToken, response.authResponse.userID);[m
[31m-            }[m
[31m-          });[m
[31m-        };[m
[32m+[m[32m          setSdkReady(true);[m
[32m+[m[32m          setIsInitializing(false);[m
[32m+[m[41m          [m
[32m+[m[32m          // Check login status after initialization[m
[32m+[m[32m          setTimeout(() => {[m
[32m+[m[32m            checkLoginStatus();[m
[32m+[m[32m          }, 100);[m
[32m+[m[32m        } catch (error) {[m
[32m+[m[32m          console.error('âŒ FacebookLogin: Error initializing FB:', error);[m
[32m+[m[32m          setSdkError('Failed to initialize Facebook SDK');[m
[32m+[m[32m          setIsInitializing(false);[m
[32m+[m[32m        }[m
       };[m
     };[m
 [m
[32m+[m[32m    script.onerror = () => {[m
[32m+[m[32m      console.error('âŒ FacebookLogin: Failed to load Facebook SDK');[m
[32m+[m[32m      setSdkError('Failed to load Facebook SDK');[m
[32m+[m[32m      setIsInitializing(false);[m
[32m+[m[32m    };[m
[32m+[m
[32m+[m[32m    document.head.appendChild(script);[m
[32m+[m[32m  }, [FB_APP_ID]);[m
[32m+[m
[32m+[m[32m  // Check login status[m
[32m+[m[32m  const checkLoginStatus = useCallback(() => {[m
     if (!window.FB) {[m
[31m-      loadFacebookSDK();[m
[32m+[m[32m      console.log('ðŸ”µ FacebookLogin: FB not available for status check');[m
[32m+[m[32m      return;[m
     }[m
[31m-  }, [FB_APP_ID, onSuccess]);[m
 [m
[31m-  const handleFacebookLogin = () => {[m
[31m-    console.log('ðŸ”µ FacebookLogin: Starting login process...');[m
[31m-    setIsLoading(true);[m
[31m-    [m
[31m-    window.FB.login((response: any) => {[m
[31m-      console.log('ðŸ”µ FacebookLogin: Login response received:', response);[m
[31m-      setIsLoading(false);[m
[31m-      [m
[32m+[m[32m    console.log('ðŸ”µ FacebookLogin: Checking login status...');[m
[32m+[m[32m    window.FB.getLoginStatus((response: any) => {[m
[32m+[m[32m      console.log('ðŸ”µ FacebookLogin: getLoginStatus response:', response);[m
       if (response.status === 'connected') {[m
[31m-        console.log('âœ… FacebookLogin: Login successful, calling onSuccess...');[m
[31m-        console.log('ðŸ”µ FacebookLogin: Access token length:', response.authResponse.accessToken.length);[m
[31m-        console.log('ðŸ”µ FacebookLogin: User ID:', response.authResponse.userID);[m
[32m+[m[32m        console.log('ðŸ”µ FacebookLogin: User already connected');[m
         setIsConnected(true);[m
         setUserName(response.authResponse.userID);[m
[31m-        onSuccess(response.authResponse.accessToken, response.authResponse.userID);[m
[32m+[m[32m        // Don't call onSuccess here to avoid duplicate calls[m
       } else {[m
[31m-        console.log('âŒ FacebookLogin: Login failed, calling onError...');[m
[31m-        console.log('ðŸ”µ FacebookLogin: Response status:', response.status);[m
[31m-        console.log('ðŸ”µ FacebookLogin: Response authResponse:', response.authResponse);[m
[31m-        onError('Facebook login failed. Please try again.');[m
[32m+[m[32m        console.log('ðŸ”µ FacebookLogin: User not connected, status:', response.status);[m
[32m+[m[32m        setIsConnected(false);[m
[32m+[m[32m        setUserName('');[m
       }[m
[31m-    }, {[m
[31m-      scope: 'ads_read,ads_management,read_insights,pages_read_engagement,business_management,pages_show_list',[m
[31m-      return_scopes: true,[m
[31m-      auth_type: 'rerequest' // This helps with permission issues[m
     });[m
[31m-  };[m
[32m+[m[32m  }, []);[m
[32m+[m
[32m+[m[32m  // Initialize SDK on mount[m
[32m+[m[32m  useEffect(() => {[m
[32m+[m[32m    console.log('ðŸ”µ FacebookLogin: Component mounted, initializing SDK...');[m
[32m+[m[32m    initializeFacebookSDK();[m
[32m+[m[41m    [m
[32m+[m[32m    // Cleanup function to reset state if component unmounts[m
[32m+[m[32m    return () => {[m
[32m+[m[32m      console.log('ðŸ”µ FacebookLogin: Component unmounting, cleaning up...');[m
[32m+[m[32m      initAttempted.current = false;[m
[32m+[m[32m    };[m
[32m+[m[32m  }, [initializeFacebookSDK]);[m
[32m+[m
[32m+[m[32m  const handleFacebookLogin = useCallback(() => {[m
[32m+[m[32m    console.log('ðŸ”µ FacebookLogin: Login button clicked');[m
[32m+[m[32m    console.log('ðŸ”µ FacebookLogin: SDK ready?', isSdkReady());[m
[32m+[m[32m    console.log('ðŸ”µ FacebookLogin: Is loading?', isLoading);[m
[32m+[m[32m    console.log('ðŸ”µ FacebookLogin: Is initializing?', isInitializing);[m
[32m+[m[32m    console.log('ðŸ”µ FacebookLogin: FB available?', !!window.FB);[m
[32m+[m
[32m+[m[32m    if (!isSdkReady()) {[m
[32m+[m[32m      console.log('âŒ FacebookLogin: SDK not ready, cannot login');[m
[32m+[m[32m      onError('Facebook SDK not ready. Please try again.');[m
[32m+[m[32m      return;[m
[32m+[m[32m    }[m
 [m
[31m-  const handleFacebookLogout = () => {[m
[32m+[m[32m    if (isLoading) {[m
[32m+[m[32m      console.log('âŒ FacebookLogin: Login already in progress');[m
[32m+[m[32m      return;[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    console.log('ðŸ”µ FacebookLogin: Starting login process...');[m
[32m+[m[32m    setIsLoading(true);[m
[32m+[m[32m    setSdkError(null);[m
[32m+[m[41m    [m
[32m+[m[32m    // Add a small delay to ensure SDK is fully ready[m
[32m+[m[32m    setTimeout(() => {[m
[32m+[m[32m      if (!window.FB) {[m
[32m+[m[32m        console.log('âŒ FacebookLogin: FB not available after delay');[m
[32m+[m[32m        setIsLoading(false);[m
[32m+[m[32m        onError('Facebook SDK not available. Please try again.');[m
[32m+[m[32m        return;[m
[32m+[m[32m      }[m
[32m+[m[41m      [m
[32m+[m[32m      window.FB.login((response: any) => {[m
[32m+[m[32m        console.log('ðŸ”µ FacebookLogin: Login response received:', response);[m
[32m+[m[32m        setIsLoading(false);[m
[32m+[m[41m        [m
[32m+[m[32m        if (response.status === 'connected') {[m
[32m+[m[32m          console.log('âœ… FacebookLogin: Login successful, calling onSuccess...');[m
[32m+[m[32m          console.log('ðŸ”µ FacebookLogin: Access token length:', response.authResponse.accessToken.length);[m
[32m+[m[32m          console.log('ðŸ”µ FacebookLogin: User ID:', response.authResponse.userID);[m
[32m+[m[32m          setIsConnected(true);[m
[32m+[m[32m          setUserName(response.authResponse.userID);[m
[32m+[m[32m          onSuccess(response.authResponse.accessToken, response.authResponse.userID);[m
[32m+[m[32m        } else {[m
[32m+[m[32m          console.log('âŒ FacebookLogin: Login failed, calling onError...');[m
[32m+[m[32m          console.log('ðŸ”µ FacebookLogin: Response status:', response.status);[m
[32m+[m[32m          console.log('ðŸ”µ FacebookLogin: Response authResponse:', response.authResponse);[m
[32m+[m[41m          [m
[32m+[m[32m          let errorMessage = 'Facebook login failed. Please try again.';[m
[32m+[m[32m          if (response.status === 'not_authorized') {[m
[32m+[m[32m            errorMessage = 'Login was cancelled or permissions were denied.';[m
[32m+[m[32m          }[m
[32m+[m[41m          [m
[32m+[m[32m          onError(errorMessage);[m
[32m+[m[32m        }[m
[32m+[m[32m      }, {[m
[32m+[m[32m        scope: 'ads_read,ads_management,read_insights,pages_read_engagement,business_management,pages_show_list',[m
[32m+[m[32m        return_scopes: true,[m
[32m+[m[32m        auth_type: 'rerequest'[m
[32m+[m[32m      });[m
[32m+[m[32m    }, 100);[m
[32m+[m[32m  }, [isSdkReady, onSuccess, onError, isLoading, isInitializing]);[m
[32m+[m
[32m+[m[32m  const handleFacebookLogout = useCallback(() => {[m
[32m+[m[32m    if (!window.FB) return;[m
[32m+[m[41m    [m
     window.FB.logout((response: any) => {[m
[32m+[m[32m      console.log('ðŸ”µ FacebookLogin: Logout response:', response);[m
       setIsConnected(false);[m
       setUserName('');[m
     });[m
[31m-  };[m
[32m+[m[32m  }, []);[m
 [m
[31m-  if (!window.FB) {[m
[31m-    console.log('ðŸ”µ FacebookLogin: FB not available, showing loading state');[m
[31m-    [m
[31m-    // Check if we have a valid App ID[m
[31m-    if (FB_APP_ID === 'your-facebook-app-id' || !FB_APP_ID) {[m
[31m-      return ([m
[31m-        <div className="space-y-4">[m
[31m-          <div className="flex items-center p-3 bg-red-50 border border-red-200 rounded-lg">[m
[31m-            <AlertCircle className="w-5 h-5 text-red-600 mr-2" />[m
[31m-            <div>[m
[31m-              <p className="text-sm font-medium text-red-800">Facebook App ID Not Configured</p>[m
[31m-              <p className="text-xs text-red-600">[m
[31m-                Please update your .env.local file with a valid Facebook App ID[m
[31m-              </p>[m
[31m-            </div>[m
[32m+[m[32m  // Show error state if SDK failed to load[m
[32m+[m[32m  if (sdkError) {[m
[32m+[m[32m    return ([m
[32m+[m[32m      <div className="space-y-4">[m
[32m+[m[32m        <div className="flex items-center p-3 bg-red-50 border border-red-200 rounded-lg">[m
[32m+[m[32m          <AlertCircle className="w-5 h-5 text-red-600 mr-2" />[m
[32m+[m[32m          <div>[m
[32m+[m[32m            <p className="text-sm font-medium text-red-800">Facebook SDK Error</p>[m
[32m+[m[32m            <p className="text-xs text-red-600">{sdkError}</p>[m
           </div>[m
[31m-          <div className="text-xs text-gray-500">[m
[31m-            <p>Current App ID: {FB_APP_ID}</p>[m
[31m-            <p>Follow the setup guide: FACEBOOK_APP_SETUP_QUICK.md</p>[m
[32m+[m[32m        </div>[m
[32m+[m[32m        <button[m
[32m+[m[32m          onClick={() 